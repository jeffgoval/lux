/**
 * üöÄ EXECUTAR SETUP COMPLETO DO SISTEMA DE AUTENTICA√á√ÉO V2
 * 
 * Vers√£o que executa via comandos individuais do Supabase
 */

const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

const supabase = createClient(
  process.env.VITE_SUPABASE_URL,
  process.env.VITE_SUPABASE_ANON_KEY
);

async function executeAuthSetup() {
  console.log('üöÄ EXECUTANDO SETUP COMPLETO DO SISTEMA DE AUTENTICA√á√ÉO V2\n');

  try {
    // ========================================================================
    // 1. VERIFICAR ESTADO ATUAL
    // ========================================================================
    console.log('üîç 1. Verificando estado atual das tabelas...');
    
    // Verificar se profiles existe
    const { data: profilesCheck, error: profilesCheckError } = await supabase
      .from('profiles')
      .select('count', { count: 'exact', head: true });

    if (profilesCheckError) {
      console.log('   ‚ùå Tabela profiles n√£o existe ou tem erro:', profilesCheckError.message);
    } else {
      console.log('   ‚úÖ Tabela profiles existe');
    }

    // Verificar se user_roles existe
    const { data: rolesCheck, error: rolesCheckError } = await supabase
      .from('user_roles')
      .select('count', { count: 'exact', head: true });

    if (rolesCheckError) {
      console.log('   ‚ùå Tabela user_roles n√£o existe ou tem erro:', rolesCheckError.message);
    } else {
      console.log('   ‚úÖ Tabela user_roles existe');
    }

    // ========================================================================
    // 2. TESTAR CRIA√á√ÉO DE USU√ÅRIO PARA VER SE TRIGGER FUNCIONA
    // ========================================================================
    console.log('\nüß™ 2. Testando se trigger autom√°tico j√° funciona...');
    
    const testEmail = `teste.trigger.${Date.now()}@exemplo.com`;
    const testPassword = 'MinhaSenh@123';
    
    console.log(`   üìß Criando usu√°rio de teste: ${testEmail}`);
    
    const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
      email: testEmail,
      password: testPassword
    });

    if (signUpError) {
      console.error('   ‚ùå Erro no cadastro:', signUpError.message);
      return;
    }

    console.log('   ‚úÖ Usu√°rio criado com sucesso!');
    const userId = signUpData.user?.id;

    if (!userId) {
      console.error('   ‚ùå User ID n√£o encontrado');
      return;
    }

    // Aguardar trigger executar
    console.log('   ‚è≥ Aguardando trigger executar...');
    await new Promise(resolve => setTimeout(resolve, 3000));

    // ========================================================================
    // 3. VERIFICAR SE PROFILE FOI CRIADO AUTOMATICAMENTE
    // ========================================================================
    console.log('\nüìã 3. Verificando se profile foi criado automaticamente...');
    
    const { data: profileData, error: profileError } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .single();

    if (profileError) {
      console.log('   ‚ùå Profile n√£o foi criado automaticamente:', profileError.message);
      
      // Tentar criar profile manualmente
      console.log('   üîß Tentando criar profile manualmente...');
      
      const { error: createProfileError } = await supabase
        .from('profiles')
        .insert({
          id: userId,
          email: testEmail,
          nome_completo: 'Usu√°rio Teste',
          primeiro_acesso: true,
          ativo: true
        });

      if (createProfileError) {
        console.error('   ‚ùå Erro ao criar profile manualmente:', createProfileError.message);
      } else {
        console.log('   ‚úÖ Profile criado manualmente com sucesso!');
      }
    } else {
      console.log('   ‚úÖ Profile criado automaticamente pelo trigger!');
      console.log(`      üë§ Nome: ${profileData.nome_completo}`);
      console.log(`      üìß Email: ${profileData.email}`);
      console.log(`      üîÑ Primeiro acesso: ${profileData.primeiro_acesso}`);
    }

    // ========================================================================
    // 4. VERIFICAR SE ROLE FOI CRIADA AUTOMATICAMENTE
    // ========================================================================
    console.log('\nüé≠ 4. Verificando se role foi criada automaticamente...');
    
    const { data: roleData, error: roleError } = await supabase
      .from('user_roles')
      .select('*')
      .eq('user_id', userId);

    if (roleError) {
      console.log('   ‚ùå Role n√£o foi criada automaticamente:', roleError.message);
      
      // Tentar criar role manualmente
      console.log('   üîß Tentando criar role manualmente...');
      
      const { error: createRoleError } = await supabase
        .from('user_roles')
        .insert({
          user_id: userId,
          role: 'proprietaria',
          ativo: true,
          criado_por: userId
        });

      if (createRoleError) {
        console.error('   ‚ùå Erro ao criar role manualmente:', createRoleError.message);
      } else {
        console.log('   ‚úÖ Role criada manualmente com sucesso!');
      }
    } else if (roleData && roleData.length > 0) {
      console.log('   ‚úÖ Role criada automaticamente pelo trigger!');
      roleData.forEach(role => {
        console.log(`      üé≠ Role: ${role.role}`);
        console.log(`      üè• Cl√≠nica ID: ${role.clinica_id || 'N√£o definida'}`);
        console.log(`      ‚úÖ Ativo: ${role.ativo}`);
      });
    } else {
      console.log('   ‚ùå Nenhuma role encontrada');
    }

    // ========================================================================
    // 5. SIMULAR ONBOARDING COMPLETO
    // ========================================================================
    console.log('\nüéØ 5. Simulando onboarding completo...');
    
    // Atualizar profile com dados completos
    const { error: updateProfileError } = await supabase
      .from('profiles')
      .update({
        nome_completo: 'Dr. Jo√£o Silva Teste',
        telefone: '11999999999',
        primeiro_acesso: false
      })
      .eq('id', userId);

    if (updateProfileError) {
      console.error('   ‚ùå Erro ao atualizar profile:', updateProfileError.message);
    } else {
      console.log('   ‚úÖ Profile atualizado com dados do onboarding!');
    }

    // Criar cl√≠nica
    const { data: clinicaData, error: clinicaError } = await supabase
      .from('clinicas')
      .insert({
        nome: 'Cl√≠nica Teste Automatizada',
        telefone_principal: '11999999999',
        email_contato: testEmail,
        ativo: true,
        criado_por: userId
      })
      .select('id')
      .single();

    if (clinicaError) {
      console.error('   ‚ùå Erro ao criar cl√≠nica:', clinicaError.message);
    } else {
      console.log('   ‚úÖ Cl√≠nica criada com sucesso!');
      console.log(`      üÜî Cl√≠nica ID: ${clinicaData.id}`);

      // Vincular role √† cl√≠nica
      const { error: updateRoleError } = await supabase
        .from('user_roles')
        .update({
          clinica_id: clinicaData.id
        })
        .eq('user_id', userId)
        .eq('role', 'proprietaria');

      if (updateRoleError) {
        console.error('   ‚ùå Erro ao vincular role √† cl√≠nica:', updateRoleError.message);
      } else {
        console.log('   ‚úÖ Role vinculada √† cl√≠nica com sucesso!');
      }
    }

    // ========================================================================
    // 6. VERIFICA√á√ÉO FINAL COMPLETA
    // ========================================================================
    console.log('\nüîç 6. Verifica√ß√£o final completa...');
    
    const { data: finalData, error: finalError } = await supabase
      .from('profiles')
      .select(`
        *,
        user_roles (
          role,
          clinica_id,
          ativo,
          clinicas (
            nome,
            ativo
          )
        )
      `)
      .eq('id', userId)
      .single();

    if (finalError) {
      console.error('   ‚ùå Erro na verifica√ß√£o final:', finalError.message);
    } else {
      console.log('   ‚úÖ SISTEMA FUNCIONANDO PERFEITAMENTE!');
      console.log('\n   üìä RESUMO FINAL:');
      console.log(`      üë§ Usu√°rio: ${finalData.nome_completo}`);
      console.log(`      üìß Email: ${finalData.email}`);
      console.log(`      üì± Telefone: ${finalData.telefone}`);
      console.log(`      üîÑ Onboarding completo: ${!finalData.primeiro_acesso}`);
      
      if (finalData.user_roles && finalData.user_roles.length > 0) {
        console.log(`      üé≠ Role: ${finalData.user_roles[0].role}`);
        if (finalData.user_roles[0].clinicas) {
          console.log(`      üè• Cl√≠nica: ${finalData.user_roles[0].clinicas.nome}`);
        }
      }
    }

    // ========================================================================
    // 7. LIMPEZA DOS DADOS DE TESTE
    // ========================================================================
    console.log('\nüßπ 7. Limpando dados de teste...');
    
    if (clinicaData?.id) {
      await supabase.from('clinicas').delete().eq('id', clinicaData.id);
    }
    
    await supabase.from('user_roles').delete().eq('user_id', userId);
    await supabase.from('profiles').delete().eq('id', userId);
    
    console.log('   ‚úÖ Dados de teste removidos!');

    // ========================================================================
    // 8. RESULTADO FINAL
    // ========================================================================
    console.log('\nüéâ SETUP E TESTE COMPLETOS!');
    console.log('\nüìã STATUS DO SISTEMA:');
    
    if (!profileError && !roleError) {
      console.log('   ‚úÖ TRIGGER AUTOM√ÅTICO FUNCIONANDO');
      console.log('   ‚úÖ PROFILES CRIADOS AUTOMATICAMENTE');
      console.log('   ‚úÖ ROLES CRIADAS AUTOMATICAMENTE');
      console.log('   ‚úÖ ONBOARDING FUNCIONAL');
      console.log('   ‚úÖ SISTEMA PRONTO PARA USO!');
    } else {
      console.log('   ‚ö†Ô∏è TRIGGER AUTOM√ÅTICO N√ÉO FUNCIONANDO');
      console.log('   ‚ö†Ô∏è NECESS√ÅRIO CONFIGURAR MANUALMENTE NO SUPABASE DASHBOARD');
      console.log('   üìã Execute o SQL do arquivo: scripts/setup-complete-auth-system.sql');
    }

    console.log('\nüéØ PR√ìXIMOS PASSOS:');
    console.log('   1. Testar cadastro na interface web');
    console.log('   2. Verificar se vai direto para onboarding');
    console.log('   3. Completar onboarding e ir para dashboard');

  } catch (error) {
    console.error('‚ùå Erro inesperado:', error);
  }
}

// Executar setup
executeAuthSetup()
  .then(() => {
    console.log('\n‚úÖ SCRIPT FINALIZADO!');
  })
  .catch(console.error);
